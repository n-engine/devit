#!/usr/bin/env bash
set -euo pipefail

LOG_DIR="/tmp/devit-notify"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/notify.log"
export DISPLAY="${DISPLAY:-:0}"

# Config retry
MAX_RETRIES=3
RETRY_DELAY=15
ACK_TIMEOUT=30

TASK_ID="${DEVIT_NOTIFY_TASK_ID:-}"
STATUS="${DEVIT_NOTIFY_STATUS:-}"

# Log initial
{
  echo "[$(date --iso-8601=seconds)] Notification re√ßue"
  echo "  DISPLAY: ${DISPLAY}"
  echo "  Task: ${TASK_ID:-<unset>} | Status: ${STATUS:-<unset>}"
} >>"$LOG_FILE"

# Validation
[[ -z "$TASK_ID" || -z "$STATUS" ]] && {
  echo "  ‚ùå Vars manquantes, skip" >>"$LOG_FILE"
  exit 0
}

# Pr√©pare marker ACK (daemon override ou fallback)
ACK_MARKER="${DEVIT_ACK_MARKER:-$LOG_DIR/ack-${TASK_ID}-$$}"
echo "  ACK marker: ${ACK_MARKER}" >>"$LOG_FILE"

# Fonction: envoyer message √† Claude
send_to_claude() {
  local msg="task: ${TASK_ID} status: ${STATUS}"
  
  # Ajoute summary si <= 20 chars
  if [[ -n "${DEVIT_NOTIFY_SUMMARY:-}" ]]; then
    local summary_len=${#DEVIT_NOTIFY_SUMMARY}
    if [[ $summary_len -le 20 ]]; then
      msg+=" | ${DEVIT_NOTIFY_SUMMARY}"
    fi
  fi
  
  # V√©rifie tools dispos
  if ! command -v wmctrl >/dev/null || ! command -v xdotool >/dev/null; then
    echo "  ‚ö†Ô∏è  wmctrl/xdotool manquant" >>"$LOG_FILE"
    return 1
  fi
  
  # Focus Claude window
  if ! timeout 5 wmctrl -xa "Claude" 2>&1 >>"$LOG_FILE"; then
    echo "  ‚ö†Ô∏è  Claude window not found" >>"$LOG_FILE"
    return 1
  fi
  
  sleep 0.5
  xdotool type "${msg}" 2>&1 >>"$LOG_FILE"
  sleep 0.5
  xdotool key Return 2>&1 >>"$LOG_FILE"
  
  echo "  ‚úÖ Message envoy√©" >>"$LOG_FILE"
  return 0
}

# Fonction: attendre ACK du daemon
wait_for_ack() {
  local timeout=$ACK_TIMEOUT
  
  for i in $(seq 1 $timeout); do
    if [[ -f "$ACK_MARKER" ]]; then
      echo "  ‚úÖ ACK re√ßu (${i}s)" >>"$LOG_FILE"
      rm -f "$ACK_MARKER"
      return 0
    fi
    sleep 1
  done
  
  echo "  ‚ö†Ô∏è  Timeout ACK (${timeout}s)" >>"$LOG_FILE"
  return 1
}

# Main retry loop
for attempt in $(seq 1 $MAX_RETRIES); do
  {
    echo ""
    echo "[$(date --iso-8601=seconds)] Tentative ${attempt}/${MAX_RETRIES}"
  } >>"$LOG_FILE"
  
  # Envoyer message
  if send_to_claude; then
    # Attendre ACK
    if wait_for_ack; then
      echo "  üéâ Notification compl√®te avec ACK" >>"$LOG_FILE"
      exit 0
    fi
  else
    echo "  ‚ùå √âchec envoi message" >>"$LOG_FILE"
  fi
  
  # Retry delay (sauf derni√®re tentative)
  if [[ $attempt -lt $MAX_RETRIES ]]; then
    echo "  ‚è≥ Retry dans ${RETRY_DELAY}s..." >>"$LOG_FILE"
    sleep $RETRY_DELAY
    export ACK_TIMEOUT=$((10 + (attempt - 1) * 10)) 
  fi
done

# √âchec final
{
  echo ""
  echo "[$(date --iso-8601=seconds)] ‚ùå √âCHEC FINAL"
  echo "  Claude probablement offline ou occup√©"
  echo "  Task: ${TASK_ID} | Status: ${STATUS}"
} >>"$LOG_FILE"

exit 1
