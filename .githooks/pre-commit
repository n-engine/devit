#!/usr/bin/env bash
set -euo pipefail

# ---- Config rapide ----
# SKIP_HOOK=1       â†’ saute le hook
# FULL_HOOK=1       â†’ exÃ©cute Clippy complet (plus lent)
# SYM_GUARD=â€¦       â†’ regex personnalisÃ©e pour les symboles

if [[ "${SKIP_HOOK:-}" == "1" ]]; then
  echo "â­  pre-commit: SKIP_HOOK=1 â†’ ignorÃ©"
  exit 0
fi

# Fichiers Rust indexÃ©s (staged)
STAGED_RS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.rs$' || true)
if [[ -z "$STAGED_RS" ]]; then
  echo "âœ… pre-commit: aucun .rs indexÃ©, rien Ã  vÃ©rifier."
  exit 0
fi

echo "ğŸ” pre-commit: vÃ©rification du code Rustâ€¦"

# 1) Format (rapide)
cargo fmt --all -- --check

# 2) Build lÃ©ger (rapide). On Ã©vite clippy systÃ©matique pour la vitesse.
cargo check --workspace -q

# 3) (dÃ©sactivÃ©) Garde-fou anti-doublons trop bruyant pour lâ€™instant
#SYM_REGEX="${SYM_GUARD:-pub (struct|enum|trait|fn) (AtomicPatcher|PatchStats|ParsedPatch|PatchHunk|PatchLine|DelegatedTask|Orchestration|Journal|Std(Error|Response)|SnapshotId|FileContent|Policy(Action|Rule)|OperationType|Task(Status|Notification))}"
#
#echo "ğŸ§­ scan doublons de symboles publicsâ€¦ (dÃ©sactivÃ©)"
#if command -v rg >/dev/null 2>&1; then
#  rg -n "$SYM_REGEX" crates | tee /tmp/pub_symbols.txt || true
#else
#  grep -RInE "$SYM_REGEX" crates | tee /tmp/pub_symbols.txt || true
#fi
#
#if grep -qv 'crates/common' /tmp/pub_symbols.txt 2>/dev/null; then
#  echo "â„¹ï¸  Alerte doublons ignorÃ©e (hook dÃ©sactivÃ©)."
#fi

# 4) Optionnel : Clippy strict (lent) si demandÃ©
if [[ "${FULL_HOOK:-}" == "1" ]]; then
  echo "ğŸ¦€ clippy strictâ€¦ (peut Ãªtre long)"; echo
  cargo clippy --workspace -- -D warnings
fi

# Interdire les fichiers > 2000 lignes (sauf tests)
find crates/mcp-tools/src -type f -name '*.rs' \
  -exec awk 'END{if(NR>2000){exit 1}}' {} \; -print

if rg -n 'DevItError::Internal\(' crates/cli | grep -v 'internal\(' >/dev/null; then
  echo "âŒ Utilisation brute de DevItError::Internal dÃ©tectÃ©e (utilise DevItError::internal(...))"
  exit 1
fi

# Interdire une redÃ©finition locale de OrchestrationConfig
rg -n 'struct OrchestrationConfig\b' crates/cli && exit 1

# VÃ©rifier que to_format nâ€™existe que cÃ´tÃ© CLI :
rg -n 'fn to_format\(' crates/common && exit 1

# Io brut interdit
if rg -n 'DevItError::Io\s*\{' crates/cli | grep -v 'DevItError::io' >/dev/null; then
  echo "âŒ DevItError::Io brut dÃ©tectÃ© â†’ utilise DevItError::io(Some(path)|None, err)"; exit 1
fi

# Casts usizeâ†’u32 Ã  surveiller (dans patch.rs)
if rg -n '\bas u32\b' crates/cli/src/core/patch.rs >/dev/null; then
  echo "âš ï¸  usizeâ†’u32 encore prÃ©sents dans patch.rs â†’ remplacer par u32_sat/u32_checked"; exit 1
fi


echo "âœ… pre-commit: OK"
exit 0
